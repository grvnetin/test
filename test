import logging
import os
from atlassian import Confluence
from publish_utils import find_md_files, post_release_notes_to_confluence, read_json_file
from constants import MONTHLY_DATA_FILE_NAME
import config_settings

logging.basicConfig()
logger = logging.getLogger(__name__)
logger.setLevel(logging.DEBUG)

def main():
    # Confluence Credentials (from environment variables)
    confluence_url = os.getenv("ATLASSIAN_URL")
    confluence_email = os.getenv("ATLASSIAN_EMAIL2")
    confluence_api_token = os.getenv("ATLASSIAN_API_TOKEN2")
    confluence_space_key = os.getenv("CONFLUENCE_SPACE_KEY")
    
    project_dir = os.getenv("CI_PROJECT_DIR", "")

    # Page ID from config (MonthlyReport section)
    WORKSPACE_MONTHLY_PAGE_ID = config_settings.cfgparser["MonthlyReport"].get("workspace_page_id")

    # Find generated monthly markdown reports
    projects = find_md_files(project_dir, "jira_monthly_report_")
    logger.debug(projects)
    
    if not projects:
        logger.warning("No monthly markdown files found.")
        return
        
    # Initialize Confluence client
    confluence = Confluence(
        url=confluence_url,
        username=confluence_email,
        password=confluence_api_token,
    )

    # Read month label from metadata
    month_data = read_json_file(os.path.join(project_dir, MONTHLY_DATA_FILE_NAME))
    month_label = month_data.get("month", "Unknown-Month")

    # Create a Confluence page title like "2025-08 Monthly Report"
    page_title = f"{month_label} Monthly Report"

    # Publish to Confluence
    post_release_notes_to_confluence(
        confluence, confluence_space_key, projects, WORKSPACE_MONTHLY_PAGE_ID, project_dir
    )

if __name__ == "__main__":
    main()
